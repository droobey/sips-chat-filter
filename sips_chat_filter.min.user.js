// ==UserScript==
// @name        Sips Chat Filter
// @namespace   https://github.com/droobey/sips-chat-filter
// @description Tracks and hides !bets from Sips twitch chat. Made for /r/sips
// @author      /u/droobey
// @updateURL   http://droobey.github.io/sips-chat-filter/sips_chat_filter.meta.js
// @downloadURL   https://raw.githubusercontent.com/droobey/sips-chat-filter/master/sips_chat_filter.min.user.js
// @include     /^https?://(www|beta)\.twitch\.tv\/(sips_(/(chat.*)?)?|chat\/.*channel=sips_.*)$/
// @version     1.01
// @grant       none
// @run-at      document-end
// ==/UserScript==

!function(e){"use strict";var t=document.createElement("script");t.appendChild(document.createTextNode("("+e.toString()+"());")),document.body.appendChild(t)}(function(){"use strict";function e(e,t){for(var n=0;n<e.length;n++)t(e[n],n,e)}function t(e,t){for(var n=0;n<e.length;n++)if(t(e[n]))return!0;return!1}function n(e,t){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function i(e){y.push(e)}function a(){e(y,function(e){e()})}function o(t){e(_,function(e){if(!(e in t))throw new Error("Missing param "+e)}),n(t,function(e){if(_.indexOf(e)<0&&x.indexOf(e)<0)throw new Error("Unexpected param "+e)});var i=this;n(t,function(e,t){i[e]=t}),this._value=null,this._observers=[]}function s(e){var t=new o(e);T.push(t),V[t.name]=t,t.message_filter&&C.push(t),t.message_css&&S.push(t),t.message_rewriter&&k.push(t)}function r(e){return V[e].getValue()}function c(e){var t=localStorage.getItem(e);return t?JSON.parse(t):null}function u(e,t){localStorage.setItem(e,JSON.stringify(t))}function l(){var e;e=window.localStorage?c(I)||get_old_saved_settings():{},n(V,function(t,n){n.setValue(t in e?e[t]:null)})}function d(){if(window.localStorage){var e={};n(V,function(t,n){null!==n._value&&(e[t]=n._value)}),u(I,e)}}function p(e){$("head").append("<style>"+e.join("")+"</style>")}function f(e){$("#sips-bet").length<=0&&$(".chat-room").append(z),$("#sips-bet").html(e),$("#sips-bet").show()}function m(e,n){if("!betting"==e.substring(0,"!betting".length))return i;var i=t(Y,function(t){if(e.substring(0,t.length)===t){if(e.substring(0,t.length)===Y[0]&&n===B&&r("SipsTrackBet")){var i=e.split(" ");H=i[1],M=i[2]}return!0}});return i}function g(e,t,n){var i=!1;if(("owner"==n[0]||"mod"==n[0])&&(i=!0),e.substring(0,F.length)===F){if(!i)return!0;A=[];var a=e.split(" ");clearTimeout(l);var o="Betting is open!<br/>";o+=a[4].replace(/_/g," ")+"<br/>",parseInt(a[3])>0&&(o+=" Minimum bet of "+a[3]),parseInt(a[2])>0&&(o+="Max bet of "+a[2]+" dicks"),o+="<br/>";var s=1;for(index=5;index<a.length;++index)o+=s+") "+a[index]+" ",A.push(a[index]),s++;f(o)}if(e.substring(0,U.length)===U){if(!i||A==[])return!0;var r="Betting is now closed!<br/>";r+=M>0?"You bet "+H+" on "+A[parseInt(M)-1]:"You did not bet any dicks!",f(r)}if(e.substring(0,q.length)===q){if(!i||A==[])return!0;var a=e.split(" "),c=A[parseInt(a[2])-1],u="Bet result<br/>"+a[2]+") "+c+" won!";u+=parseInt(a[2])==M?"<br/>You won!":"<br/>You lost "+H+" dicks!",f(u),H=0,M=0;var l=setTimeout(function(){$("#sips-bet").hide()},3e4)}return!1}function h(t,n,i){var a={};return t=t||"",n=n||"",e(C,function(e){a[e.name]=e.message_filter(t,n,i)}),a}function v(){a(),l(),console.log(w)}if(window.$){var b="1.0",w="Sips Chat Filter version "+b+" loaded. ",y=[],_=["name","comment","category","defaultValue"],x=["longComment","message_filter","message_css","message_rewriter"];o.prototype.getValue=function(){return null!==this._value?this._value:this.defaultValue},o.prototype.setValue=function(t){var n=this.getValue();this._value=t;var i=this.getValue();e(this._observers,function(e){e(i,n)})},o.prototype.reset=function(){this.setValue(null)},o.prototype.observe=function(e){this._observers.push(e)},o.prototype.forceObserverUpdate=function(){var t=this.getValue();e(this._observers,function(e){e(t,t)})};var T=[],V={},C=[],k=[],S=[],I="sips-chat-filter-settings";i(function(){e(T,function(e){e.observe(function(){d()})})});var N=".chat-room",O=".message",j=".from",E=".chat-line",z=$("<div></div>");if(z.attr("id","sips-bet"),z.css("background-color","#65a2d5"),z.css("color","white"),z.css("z-index","9999"),z.css("position","absolute"),z.css("top","0px"),z.css("right","0px"),z.css("width","100%"),z.css("font-size","120%"),z.css("display","none"),Twitch.user.displayName())var B=Twitch.user.displayName().toLowerCase();else var B="";var H=0,M=0,Y=["!bets","!bet "];s({name:"SipsHideBet",comment:"Hide !bets",longComment:Y.join(", "),category:"filters_category",defaultValue:!0,message_filter:m});var F="!betting start",U="!betting close",q="!betting winoption",A=[];s({name:"SipsTrackBet",comment:"Track !betting",longComment:Y.join(", "),category:"filters_category",defaultValue:!0,message_filter:g});var J=".chat-settings";if(i(function(){function t(){var e=r.height();e>0&&s.css("max-height",.9*e)}function n(e,t){e.append($("<label>").attr("for",t.name).attr("title",t.longComment||"").append($('<input type="checkbox">').attr("id",t.name)).append(document.createTextNode(" "+t.comment)));var n=$("#"+t.name);n.on("change",function(){t.setValue($(this).prop("checked"))}),t.observe(function(e){n.prop("checked",e)})}function i(t,n){function i(e){var t=n.getValue().slice();t.splice(e,1),n.setValue(t)}function a(){$("#show-"+n.name).show(),$("#hide-"+n.name).hide(),$("#clear-"+n.name).hide(),$("#list-"+n.name).hide()}t.append($("<label>").attr("for",n.name).attr("title",n.longComment||"").append(document.createTextNode("Add "+n.comment)).append($('<input type="text">').attr("id",n.name).css("width","100%"))).append($("<button>").attr("id","show-"+n.name).append(document.createTextNode("Show ")).append($("<span>").attr("id","num-banned-"+n.name)).append(document.createTextNode(" "+n.comment))).append($("<button>").attr("id","hide-"+n.name).append(document.createTextNode("Hide "+n.comment))).append($('<div class="custom_list_menu">').attr("id","list-"+n.name)).append($("<button>").attr("id","clear-"+n.name).append(document.createTextNode("Clear "+n.comment))),a(),n.observe(function(t){$("#num-banned-"+n.name).text(t.length);var a=$("#list-"+n.name);a.empty(),e(t,function(e,t){a.append($("<li>").text(e).append($('<a href="#">').text("[X]").click(function(){i(t)})))})})}function a(e){$('<div class="list-header"/>').text(e).appendTo(s);var t=$('<div class="chat-menu-content">').appendTo(s);return t}function o(t,a){e(T,function(e){if(e.category===a){var o=$("<p>").attr("id","menu-"+e.name).addClass("dropmenu_action").appendTo(t),s=typeof e.defaultValue;if("boolean"===s)n(o,e);else{if("object"!==s)throw new Error("Unrecognized setting "+s);i(o,e)}}})}p([".chat-room { z-index: inherit !important; }",".chat-settings { z-index: 100 !important; }",".custom_list_menu li {background: #bbb; display: block; list-style: none; margin: 1px 0; padding: 0 2px}",".custom_list_menu li a {float: right;}"]);var s=$(J),r=$(N);s.css("overflow-y","auto"),t(),setInterval(t,500),$(window).resize(t);var c=a("Hide");o(c,"filters_category");var u=a("Misc");u.append($("<button>Reset Sips Filter settings</a>").click(function(){confirm("This will reset all Sips Chat Filter settings to their default values. Are you sure you want to continue?")&&e(T,function(e){e.reset()})}))}),i(function(){var t=[];e(S,function(e){t.push(N+"."+e.name+" "+e.message_css)}),p(t),e(S,function(e){e.observe(function(t){$(N).toggleClass(e.name,t)})})}),i(function(){var t=[];e(C,function(e){var n=e.name,i=e.name+"Hidden";t.push(N+"."+i+" "+E+"."+n+"{display:none}"),e.observe(function(){$(N).toggleClass(i,e.getValue())})}),p(t)}),i(function(){var t=require("web-client/components/chat-line")["default"].prototype,n=t.didInsertElement;t.didInsertElement=function(){n.apply(this,arguments);var e=this.$(),t=h(this.get("msgObject.message"),this.get("msgObject.from"),this.get("msgObject.labels"));for(var i in t)e.toggleClass(i,t[i])},$(E).each(function(){var t=$(this),n=t.find(O).text().trim(),i=t.find(j).text().trim();e(C,function(e){t.toggleClass(e.name,e.message_filter(n,i,label))})})}),$(J).length)v();else{var L=require("web-client/views/chat")["default"].prototype,P=L.didInsertElement;L.didInsertElement=function(){P&&P.apply(this,arguments),v()}}}});
// ==UserScript==
// @name        Sips Chat Filter
// @namespace   https://github.com/droobey/sips-chat-filter
// @description Tracks and hides !bets from Sips twitch chat. Made for /r/sips
// @author      /u/droobey
// @include     /^https?://(www|beta)\.twitch\.tv\/(sips_(/(chat.*)?)?|chat\/.*channel=sips_.*)$/
// @version     1.0
// @grant       none
// @run-at      document-end
// ==/UserScript==

!function(e){"use strict";var t=document.createElement("script");t.appendChild(document.createTextNode("("+e.toString()+"());")),document.body.appendChild(t)}(function(){"use strict";function e(e,t){for(var n=0;n<e.length;n++)t(e[n],n,e)}function t(e,t){for(var n=0;n<e.length;n++)if(t(e[n]))return!0;return!1}function n(e,t){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function i(e){w.push(e)}function o(){e(w,function(e){e()})}function s(t){e(y,function(e){if(!(e in t))throw new Error("Missing param "+e)}),n(t,function(e){if(y.indexOf(e)<0&&x.indexOf(e)<0)throw new Error("Unexpected param "+e)});var i=this;n(t,function(e,t){i[e]=t}),this._value=null,this._observers=[]}function a(e){var t=new s(e);S.push(t),C[t.name]=t,t.message_filter&&T.push(t),t.message_css&&k.push(t),t.message_rewriter&&E.push(t)}function r(e){return C[e].getValue()}function c(e){var t=localStorage.getItem(e);return t?JSON.parse(t):null}function l(e,t){localStorage.setItem(e,JSON.stringify(t))}function u(){var e;e=window.localStorage?c(V)||get_old_saved_settings():{},n(C,function(t,n){n.setValue(t in e?e[t]:null)})}function p(){if(window.localStorage){var e={};n(C,function(t,n){null!==n._value&&(e[t]=n._value)}),l(V,e),localStorage.removeItem(LEGACY_FILTERS_KEY),localStorage.removeItem(LEGACY_PHRASES_KEY)}}function d(e){$("head").append("<style>"+e.join("")+"</style>")}function f(e){$("#sips-bet").length<=0&&$(".chat-room").append(B),$("#sips-bet").html(e),$("#sips-bet").is(":visible")||$("#sips-bet").show()}function m(e,n){var i=t(Y,function(t){if(e.substring(0,t.length)===t){if(e.substring(0,t.length)===Y[0]&&n===user&&r("SipsTrackBet")){var i=e.split(" ");dicks=i[1],bet_option=i[2]}return!0}});return console.log("W: "+e+" "+i),i}function g(e,t,n){console.log(n);var i=!1;if(("owner"==n[0]||"mod"==n[0])&&(i=!0),e.substring(0,z.length)===z){if(!i)return!0;A=[];var o=e.split(" "),s="Betting is open!<br/>";s+=o[4].replace(/_/g," ")+"<br/>",parseInt(o[3])>0&&(s+=" Min "+o[3]),parseInt(o[2])>0&&(s+="Max "+o[2]),s+="<br/>";var a=1;for(index=5;index<o.length;++index)s+=a+") "+o[index]+" ",A.push(o[index]),a++;console.log("BET_OPEN "+s),f(s)}if(e.substring(0,H.length)===H){if(!i)return!0;var r="Betting is now closed!<br/>";r+=bet_option>0?"You bet "+dicks+" on "+A[parseInt(bet_option)-1]:"You did not bet any dicks!",f(r)}if(e.substring(0,L.length)===L){if(!i)return!0;var o=e.split(" "),c=A[parseInt(o[2])-1],l="Bet result<br/>"+o[2]+") "+c+" won!";console.log("BET_CLOSE "+o[2]+") "+c),l+=parseInt(o[2])==bet_option?"<br/>You won!":"<br/>You lost "+dicks+" dicks!",f(l),setTimeout(function(){$("#sips-bet").hide()},3e4)}return!1}function h(t,n,i){var o={};return t=t||"",n=n||"",e(T,function(e){o[e.name]=e.message_filter(t,n,i)}),o}function v(){console.log("Loading..."),o(),u(),console.log(_)}if(window.$){var b="1.0",_="Sips Chat Filter version "+b+" loaded. ",w=[],y=["name","comment","category","defaultValue"],x=["longComment","message_filter","message_css","message_rewriter"];s.prototype.getValue=function(){return null!==this._value?this._value:this.defaultValue},s.prototype.setValue=function(t){var n=this.getValue();this._value=t;var i=this.getValue();e(this._observers,function(e){e(i,n)})},s.prototype.reset=function(){this.setValue(null)},s.prototype.observe=function(e){this._observers.push(e)},s.prototype.forceObserverUpdate=function(){var t=this.getValue();e(this._observers,function(e){e(t,t)})};var S=[],C={},T=[],E=[],k=[],V="sips-chat-filter-settings";i(function(){e(S,function(e){e.observe(function(){p()})})});var I=".chat-room",O=".message",N=".from",j=".chat-line",B=$("<div></div>");B.attr("id","sips-bet"),B.css("background-color","#65a2d5"),B.css("color","white"),B.css("z-index","9999"),B.css("position","absolute"),B.css("top","0px"),B.css("right","0px"),B.css("width","100%"),B.css("font-size","120%"),B.css("display","none"),user=Twitch.user.displayName().toLowerCase(),dicks=0,bet_option=0;var Y=["!bets","!bet "];a({name:"SipsHideBet",comment:"Hide !bets",longComment:Y.join(", "),category:"filters_category",defaultValue:!0,message_filter:m});var z="!betting start",H="!betting close",L="!betting winoption",A=[];a({name:"SipsTrackBet",comment:"Track !betting",longComment:Y.join(", "),category:"filters_category",defaultValue:!0,message_filter:g});var F=".chat-settings";if(i(function(){function t(){var e=r.height();e>0&&a.css("max-height",.9*e)}function n(e,t){e.append($("<label>").attr("for",t.name).attr("title",t.longComment||"").append($('<input type="checkbox">').attr("id",t.name)).append(document.createTextNode(" "+t.comment)));var n=$("#"+t.name);n.on("change",function(){t.setValue($(this).prop("checked"))}),t.observe(function(e){n.prop("checked",e)})}function i(t,n){function i(e){var t=n.getValue().slice();t.splice(e,1),n.setValue(t)}function o(){$("#show-"+n.name).show(),$("#hide-"+n.name).hide(),$("#clear-"+n.name).hide(),$("#list-"+n.name).hide()}t.append($("<label>").attr("for",n.name).attr("title",n.longComment||"").append(document.createTextNode("Add "+n.comment)).append($('<input type="text">').attr("id",n.name).css("width","100%"))).append($("<button>").attr("id","show-"+n.name).append(document.createTextNode("Show ")).append($("<span>").attr("id","num-banned-"+n.name)).append(document.createTextNode(" "+n.comment))).append($("<button>").attr("id","hide-"+n.name).append(document.createTextNode("Hide "+n.comment))).append($('<div class="custom_list_menu">').attr("id","list-"+n.name)).append($("<button>").attr("id","clear-"+n.name).append(document.createTextNode("Clear "+n.comment))),o(),n.observe(function(t){$("#num-banned-"+n.name).text(t.length);var o=$("#list-"+n.name);o.empty(),e(t,function(e,t){o.append($("<li>").text(e).append($('<a href="#">').text("[X]").click(function(){i(t)})))})})}function o(e){$('<div class="list-header"/>').text(e).appendTo(a);var t=$('<div class="chat-menu-content">').appendTo(a);return t}function s(t,o){e(S,function(e){if(e.category===o){var s=$("<p>").attr("id","menu-"+e.name).addClass("dropmenu_action").appendTo(t),a=typeof e.defaultValue;if("boolean"===a)n(s,e);else{if("object"!==a)throw new Error("Unrecognized setting "+a);i(s,e)}}})}d([".chat-room { z-index: inherit !important; }",".chat-settings { z-index: 100 !important; }",".custom_list_menu li {background: #bbb; display: block; list-style: none; margin: 1px 0; padding: 0 2px}",".custom_list_menu li a {float: right;}"]);var a=$(F),r=$(I);a.css("overflow-y","auto"),t(),setInterval(t,500),$(window).resize(t);var c=o("Hide");s(c,"filters_category");var l=o("Misc");l.append($("<button>Reset Sips Filter settings</a>").click(function(){confirm("This will reset all Sips Chat Filter settings to their default values. Are you sure you want to continue?")&&e(S,function(e){e.reset()})}))}),i(function(){var t=[];e(k,function(e){t.push(I+"."+e.name+" "+e.message_css)}),d(t),e(k,function(e){e.observe(function(t){$(I).toggleClass(e.name,t)})})}),i(function(){var t=[];e(T,function(e){var n=e.name,i=e.name+"Hidden";t.push(I+"."+i+" "+j+"."+n+"{display:none}"),e.observe(function(){$(I).toggleClass(i,e.getValue())})}),d(t)}),i(function(){var t=require("web-client/components/chat-line")["default"].prototype,n=t.didInsertElement;t.didInsertElement=function(){n.apply(this,arguments);var e=this.$(),t=h(this.get("msgObject.message"),this.get("msgObject.from"),this.get("msgObject.labels"));for(var i in t)e.toggleClass(i,t[i])},$(j).each(function(){var t=$(this),n=t.find(O).text().trim(),i=t.find(N).text().trim();e(T,function(e){t.toggleClass(e.name,e.message_filter(n,i,label))})})}),$(F).length)v();else{var M=require("web-client/views/chat")["default"].prototype,P=M.didInsertElement;M.didInsertElement=function(){P&&P.apply(this,arguments),v()}}}});
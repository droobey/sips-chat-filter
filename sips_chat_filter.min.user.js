// ==UserScript==
// @name        Sips Chat Filter
// @namespace   https://github.com/droobey/sips-chat-filter
// @description Tracks and hides !bets from Sips twitch chat. Made for /r/sips
// @author      /u/droobey
// @updateURL   https://github.com/droobey/sips-chat-filter/blob/master/sips_chat_filter.min.user.js
// @include     /^https?://(www|beta)\.twitch\.tv\/(sips_(/(chat.*)?)?|chat\/.*channel=sips_.*)$/
// @version     1.0
// @grant       none
// @run-at      document-end
// ==/UserScript==

!function(e){"use strict";var t=document.createElement("script");t.appendChild(document.createTextNode("("+e.toString()+"());")),document.body.appendChild(t)}(function(){"use strict";function e(e,t){for(var n=0;n<e.length;n++)t(e[n],n,e)}function t(e,t){for(var n=0;n<e.length;n++)if(t(e[n]))return!0;return!1}function n(e,t){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function i(e){_.push(e)}function o(){e(_,function(e){e()})}function s(t){e(y,function(e){if(!(e in t))throw new Error("Missing param "+e)}),n(t,function(e){if(y.indexOf(e)<0&&x.indexOf(e)<0)throw new Error("Unexpected param "+e)});var i=this;n(t,function(e,t){i[e]=t}),this._value=null,this._observers=[]}function a(e){var t=new s(e);k.push(t),T[t.name]=t,t.message_filter&&V.push(t),t.message_css&&S.push(t),t.message_rewriter&&C.push(t)}function r(e){return T[e].getValue()}function c(e){var t=localStorage.getItem(e);return t?JSON.parse(t):null}function u(e,t){localStorage.setItem(e,JSON.stringify(t))}function l(){var e;e=window.localStorage?c(I)||get_old_saved_settings():{},n(T,function(t,n){n.setValue(t in e?e[t]:null)})}function p(){if(window.localStorage){var e={};n(T,function(t,n){null!==n._value&&(e[t]=n._value)}),u(I,e)}}function d(e){$("head").append("<style>"+e.join("")+"</style>")}function f(e){$("#sips-bet").length<=0&&$(".chat-room").append(z),$("#sips-bet").html(e),$("#sips-bet").is(":visible")||$("#sips-bet").show()}function m(e,n){var i=t(B,function(t){if(e.substring(0,t.length)===t){if(e.substring(0,t.length)===B[0]&&n===user&&r("SipsTrackBet")){var i=e.split(" ");dicks=i[1],bet_option=i[2]}return!0}});return i}function g(e,t,n){var i=!1;if(("owner"==n[0]||"mod"==n[0])&&(i=!0),e.substring(0,H.length)===H){if(!i)return!0;F=[];var o=e.split(" "),s="Betting is open!<br/>";s+=o[4].replace(/_/g," ")+"<br/>",parseInt(o[3])>0&&(s+=" Minimum bet of "+o[3]),parseInt(o[2])>0&&(s+="Max bet of "+o[2]+" dicks"),s+="<br/>";var a=1;for(index=5;index<o.length;++index)s+=a+") "+o[index]+" ",F.push(o[index]),a++;f(s)}if(e.substring(0,M.length)===M){if(!i)return!0;var r="Betting is now closed!<br/>";r+=bet_option>0?"You bet "+dicks+" on "+F[parseInt(bet_option)-1]:"You did not bet any dicks!",f(r)}if(e.substring(0,Y.length)===Y){if(!i)return!0;var o=e.split(" "),c=F[parseInt(o[2])-1],u="Bet result<br/>"+o[2]+") "+c+" won!";u+=parseInt(o[2])==bet_option?"<br/>You won!":"<br/>You lost "+dicks+" dicks!",f(u),setTimeout(function(){$("#sips-bet").hide()},3e4)}return!1}function h(t,n,i){var o={};return t=t||"",n=n||"",e(V,function(e){o[e.name]=e.message_filter(t,n,i)}),o}function b(){o(),l(),console.log(w)}if(window.$){var v="1.0",w="Sips Chat Filter version "+v+" loaded. ",_=[],y=["name","comment","category","defaultValue"],x=["longComment","message_filter","message_css","message_rewriter"];s.prototype.getValue=function(){return null!==this._value?this._value:this.defaultValue},s.prototype.setValue=function(t){var n=this.getValue();this._value=t;var i=this.getValue();e(this._observers,function(e){e(i,n)})},s.prototype.reset=function(){this.setValue(null)},s.prototype.observe=function(e){this._observers.push(e)},s.prototype.forceObserverUpdate=function(){var t=this.getValue();e(this._observers,function(e){e(t,t)})};var k=[],T={},V=[],C=[],S=[],I="sips-chat-filter-settings";i(function(){e(k,function(e){e.observe(function(){p()})})});var N=".chat-room",O=".message",j=".from",E=".chat-line",z=$("<div></div>");z.attr("id","sips-bet"),z.css("background-color","#65a2d5"),z.css("color","white"),z.css("z-index","9999"),z.css("position","absolute"),z.css("top","0px"),z.css("right","0px"),z.css("width","100%"),z.css("font-size","120%"),z.css("display","none"),user=null!==Twitch.user?Twitch.user.displayName().toLowerCase():"",dicks=0,bet_option=0;var B=["!bets","!bet "];a({name:"SipsHideBet",comment:"Hide !bets",longComment:B.join(", "),category:"filters_category",defaultValue:!0,message_filter:m});var H="!betting start",M="!betting close",Y="!betting winoption",F=[];a({name:"SipsTrackBet",comment:"Track !betting",longComment:B.join(", "),category:"filters_category",defaultValue:!0,message_filter:g});var U=".chat-settings";if(i(function(){function t(){var e=r.height();e>0&&a.css("max-height",.9*e)}function n(e,t){e.append($("<label>").attr("for",t.name).attr("title",t.longComment||"").append($('<input type="checkbox">').attr("id",t.name)).append(document.createTextNode(" "+t.comment)));var n=$("#"+t.name);n.on("change",function(){t.setValue($(this).prop("checked"))}),t.observe(function(e){n.prop("checked",e)})}function i(t,n){function i(e){var t=n.getValue().slice();t.splice(e,1),n.setValue(t)}function o(){$("#show-"+n.name).show(),$("#hide-"+n.name).hide(),$("#clear-"+n.name).hide(),$("#list-"+n.name).hide()}t.append($("<label>").attr("for",n.name).attr("title",n.longComment||"").append(document.createTextNode("Add "+n.comment)).append($('<input type="text">').attr("id",n.name).css("width","100%"))).append($("<button>").attr("id","show-"+n.name).append(document.createTextNode("Show ")).append($("<span>").attr("id","num-banned-"+n.name)).append(document.createTextNode(" "+n.comment))).append($("<button>").attr("id","hide-"+n.name).append(document.createTextNode("Hide "+n.comment))).append($('<div class="custom_list_menu">').attr("id","list-"+n.name)).append($("<button>").attr("id","clear-"+n.name).append(document.createTextNode("Clear "+n.comment))),o(),n.observe(function(t){$("#num-banned-"+n.name).text(t.length);var o=$("#list-"+n.name);o.empty(),e(t,function(e,t){o.append($("<li>").text(e).append($('<a href="#">').text("[X]").click(function(){i(t)})))})})}function o(e){$('<div class="list-header"/>').text(e).appendTo(a);var t=$('<div class="chat-menu-content">').appendTo(a);return t}function s(t,o){e(k,function(e){if(e.category===o){var s=$("<p>").attr("id","menu-"+e.name).addClass("dropmenu_action").appendTo(t),a=typeof e.defaultValue;if("boolean"===a)n(s,e);else{if("object"!==a)throw new Error("Unrecognized setting "+a);i(s,e)}}})}d([".chat-room { z-index: inherit !important; }",".chat-settings { z-index: 100 !important; }",".custom_list_menu li {background: #bbb; display: block; list-style: none; margin: 1px 0; padding: 0 2px}",".custom_list_menu li a {float: right;}"]);var a=$(U),r=$(N);a.css("overflow-y","auto"),t(),setInterval(t,500),$(window).resize(t);var c=o("Hide");s(c,"filters_category");var u=o("Misc");u.append($("<button>Reset Sips Filter settings</a>").click(function(){confirm("This will reset all Sips Chat Filter settings to their default values. Are you sure you want to continue?")&&e(k,function(e){e.reset()})}))}),i(function(){var t=[];e(S,function(e){t.push(N+"."+e.name+" "+e.message_css)}),d(t),e(S,function(e){e.observe(function(t){$(N).toggleClass(e.name,t)})})}),i(function(){var t=[];e(V,function(e){var n=e.name,i=e.name+"Hidden";t.push(N+"."+i+" "+E+"."+n+"{display:none}"),e.observe(function(){$(N).toggleClass(i,e.getValue())})}),d(t)}),i(function(){var t=require("web-client/components/chat-line")["default"].prototype,n=t.didInsertElement;t.didInsertElement=function(){n.apply(this,arguments);var e=this.$(),t=h(this.get("msgObject.message"),this.get("msgObject.from"),this.get("msgObject.labels"));for(var i in t)e.toggleClass(i,t[i])},$(E).each(function(){var t=$(this),n=t.find(O).text().trim(),i=t.find(j).text().trim();e(V,function(e){t.toggleClass(e.name,e.message_filter(n,i,label))})})}),$(U).length)b();else{var q=require("web-client/views/chat")["default"].prototype,A=q.didInsertElement;q.didInsertElement=function(){A&&A.apply(this,arguments),b()}}}});